@using Microsoft.AspNetCore.Identity
@model WebStudio.ViewModels.RequestIndexViewModel
@inject UserManager<User> UserManager

@{
    ViewBag.Title = "Список запросов";
    Layout = "_Layout";
}

@{
  var count = 1;
}

<h2>Список запросов</h2>
<div class="container">
  <a asp-controller="Requests" asp-action="CreateWithoutLot" class="font-italic">Добавить новый запрос</a>
  @if (@Model.Requests.ToList().Count == 0)
  {
    <p>У вас нет запросов</p>
  }
  @if (User.IsInRole("user"))
  {
    <form method="get" class="mt-3 mb-5" style="border: 1px dotted lightslategrey; border-radius: 8px;">
      <div class="form-inline form-group">
        <div class="m-3">
          <label class="control-label">Фильтровать по </label>
          <select name="filterOrder" id="filterOrder">
            <option value="DateOfCreate">Дате создания запроса</option>
            <option value="DateOfAcceptingEnd">Дате окончания приема заявок</option>
            <option value="DateOfAuctionStart">Дате начала проведения торгов</option>
          </select>
        </div>
        <div class="m-3">
          <label class="control-label">От</label>
          <input type="date" asp-for="DateFrom">
        </div>
        <div class="m-3">
          <label class="control-label">До</label>
          <input type="date" asp-for="DateTo">
        </div>
        <div class="my-auto pt-3">
          <input type="submit" class="btn btn-outline-primary font-13 py-1 border-primary" value="Отфильтровать">
        </div>
      </div>
    </form>
  }
  @if (User.IsInRole("admin"))
  {
    <form method="get" class="mt-3 mb-5" style="border: 1px dotted lightslategrey; border-radius: 8px;">
      <div class="form-inline form-group">
        <div class="m-3">
          <label class="control-label">Фильтровать по </label>
          <select name="filterOrder" id="filterOrder">
            <option value="">По умолчанию</option>
            <option value="DateOfCreate">Дате создания запроса</option>
            <option value="DateOfAcceptingEnd">Дате окончания приема заявок</option>
            <option value="DateOfAuctionStart">Дате начала проведения торгов</option>
          </select>
        </div>
        <div class="m-3">
          <label class="control-label">От</label>
          <input type="date" value="" asp-for="DateFrom">
        </div>
        <div class="m-3">
          <label class="control-label">До</label>
          <input type="date" value="" asp-for="DateTo">
        </div>
        <div class="m-3">
          <label class="control-label">Фильтровать по исполнителю</label>
          <input type="text" asp-for="ExecutorName" name="executorName" placeholder="Введите фамилию исполнителя">
        </div>
        <div class="my-auto pt-3">
          <input type="submit" class="btn btn-outline-primary" value="Отфильтровать">
        </div>
      </div>
    </form>
  }

  <table class="table">
    <thead class="thead-light">
    <tr>
      <th scope="col">№п/п</th>
      <th scope="col">Номер лота</th>
      <th scope="col">Название лота</th>
      <th scope="col">Сумма лота</th>
      <th scope="col">Дата окончания приема заявок</th>
      <th scope="col">Дата начала проведения торгов</th>
      <th scope="col">Дата создания запроса</th>
      <th scope="col">Подробнее</th>
      @if (User.IsInRole("admin"))
      {
        <th scope="col">Ответственный</th>
      }
    </tr>
    </thead>
    @if (User.IsInRole("admin"))
    {
      foreach (var request in Model.Requests)
      {
        if (request.Card != null)
        {
          <tbody>
          <tr>
            <th scope="row">@(count++)</th>
            <td>@request.Card.Number</td>
            <td>@request.Card.Name</td>
            <td>@request.Card.StartSumm</td>
            <td>@request.Card.DateOfAcceptingEnd.ToShortDateString()</td>
            <td>@request.Card.DateOfAuctionStart.ToShortDateString()</td>
            <td>@request.DateOfCreate.ToShortDateString()</td>
            <td></td>
            <td>@request.Executor.Name @request.Executor.Surname</td>
          </tr>
          </tbody>
        }
      }
    }
    @if (User.IsInRole("user"))
    {
      foreach (var request in Model.Requests)
      {
        @if (UserManager.GetUserId(User) == @request.Executor.Id)
        {
          <tbody>
          <tr>
            <th scope="row">@(count++)</th>
            <td>@request.Card.Number</td>
            <td>@request.Card.Name</td>
            <td>@request.Card.StartSumm</td>
            <td>@request.Card.DateOfAcceptingEnd.ToShortDateString()</td>
            <td>@request.Card.DateOfAuctionStart.ToShortDateString()</td>
            <td>@request.DateOfCreate.ToShortDateString()</td>
            <td></td>
          </tr>
          </tbody>
        }
      }
    }
  </table>
</div>